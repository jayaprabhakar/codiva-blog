<!DOCTYPE html>
<html>
<head>
  <title>Serve Home Page From CDN with Cloudflare Worker</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="apple-touch-icon" sizes="57x57" href="/img/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/img/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/img/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/img/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/img/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/img/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/img/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/img/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/img/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="msapplication-TileColor" content="#243342">
  <meta name="msapplication-TileImage" content="/img/ms-icon-144x144.png">
  <meta name="theme-color" content="#243342">

  <link rel="canonical" href="https://www.codiva.io/blog/post/serve-home-page-from-cdn-cloudflare-worker/">

  <style rel="stylesheet" type="text/css">
    @import 'https://fonts.googleapis.com/css?family=Roboto:300,400,500';

    * {
      margin: 0;
      padding: 0;
      -moz-box-sizing: border-box;
      -webkit-box-sizing: border-box;
      box-sizing: border-box;
    }
    *, *:before, *:after {
      box-sizing: inherit;
    }
    body {
      font-family: "Roboto", "Helvetica", "Arial", "Verdana", sans-serif;
    }
    blockquote {
        background-color: lightgray;
        padding: 0.25em 0.5em;
        margin: 1em;
        font-size: 1.2em;
    }
    .mainContainer {
      clear: both;
    }
    .mainContainer:after {
      clear: both;
    }
    .mainContainer ol, .mainContainer ul {
      padding: 0 0 0 40px;
    }
    .mainContainer p {
      margin: 1em 0;
    }
    .header a {
      text-decoration: none;
      padding: 1.5em 1em;
    }
    .header a:link, .header a:visited {
      color: white;
      display: inline-block;
    }

    .header {
      padding: 0 10px;
      height: 4em;
      xbackground-color: #06065C;
      background-color: #243342;
      text-color: white;
    }
    .header ul {
      margin: 0px;
      padding: 0px;
    }
    .logo {
      display: inline;
      float: left;
      font-family: "Heiti SC", "Verdana", sans-serif;
    }
    .header .logo a {
      color: #4cae51;
    }
    .top-nav {
      display: inline;
      float: left;
    }
    .top-nav ul {
      list-style: none;
    }
    .top-nav li {
      display: inline;
    }
    .header .login-signup, .header .new-project {
      display: "inline";
      float: right;
    }
    .header .login-signup li,  .header .new-project li, .header .new-project li form {
      display: inline;
    }
    .header .new-project li a, .header .new-project li button {
      margin-top: 0.75em;
    }
    .humanText {
      max-width: 22em;
      margin: auto;
    }
    .header .button {
      padding: 0.75em 1em;
    }
    .bg-orange {
      background-color: #E56723;
      color: white;
    }
    .bg-green {
      background-color: #4CAF50;  

    }
    #logoutForm {
      display: inline
    }
    #logoutLink {
       display: inline;
    }
    .linkButton {
       display: inline;
       background: none;
       border: none;
       cursor: pointer;
       color: white;
    }

    .button {
      border: none;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 8px;
    }

    .modalDialog {
      z-index: 99999;
      opacity:0;
      -webkit-transition: opacity 400ms ease-in;
      -moz-transition: opacity 400ms ease-in;
      transition: opacity 400ms ease-in;
      pointer-events: none;
    }
     
    .pagination, .tags {
      height: 3em;
    }
    .pagination li, 
    .tags li {
      display: inline;
      min-height: 3em;
    }
    .pagination li a, 
    .tags li a {
      display: inline-block;
      padding: 1em;
    }
    .tags {
      list-style: none;
    }
    .main {
      max-width: 50em;
      margin: 0 auto; 
      line-height: 1.5;
      padding: 1em 1em;
      color: #555;

    }
    .main h2, .main h1 {
      margin-top: 0.5em;
      padding: 0.5em 0;
    }
    .main h1,
    .main h2,
    .main strong {
      color: #333;
    }
    .main code,
    .main pre {
      background: #eee;
    }

    .main code {
      padding: 2px 4px;
      vertical-align: text-bottom;
    }

    .main pre {
      padding: 1em;
    }

    .main a {
      color: #4cae51;
    }

   @media all and (max-width: 650px) {
    .header {
      padding: 0px;
    }
    .top-nav {
      display: none;
    }
    .screenshot, .explain {
        float: none;
        width: 95%;
        height: auto;
        padding-top:1em;
        margin: auto;
    }

    .screenshot img {
      max-width: 100%;
      margin: auto;
      display: block;
    }
   }
   @media all and (max-width: 340px) {
     .logo {
       display: none;
     }
   }        
   </style>
</head>
<body>

  <header class="header">
    <span class="logo">
      <a href="/">Codiva.io</a>
    </span>
      
    <nav class="top-nav">
      <ul>
        <li><a href="/blog">Blog</a></li>
        <li><a href="/profile">My Projects</a></li>
        <li><a href="/tutorials">Tutorials</a></li>
      </ul>
    </nav>

  </header>

  <div class="mainContainer">
    
  <div class="main">
    <h2>Serve Home Page From CDN with Cloudflare Worker</h2>
    <p>Cloudflare Service Worker helped Codiva jump at least 2 positions in Google by speading up home page response. I did it by serving the new users (and search crawler) from the edge, and avoiding redirects for logged in users.</p>

<p>Let us take a look at the undocumented hack using Cloudflare workers.
</p>

<p>You are building a SAAS product. When a user is logged in, the home page should show the user&rsquo;s personal content. If the user is not logged in, it should show the home page that convinces users&rsquo; to sign up or login (typically static content).</p>

<p>Ideally, you want the static content to be served from CDN. At the same time, you would want to avoid redirects to the logged in user.</p>

<p>If you are a developer consious of latency, you would want to serve as much content as quickly as possible. Reducing latency improves engagement. Also, Google crawler, considers latency as a ranking parameter.</p>

<p>The ultimate latency reduction guideline is to</p>

<blockquote>
<p>Serve <em>less data</em> over <em>short distance</em> with an <em>efficient protocol</em>.</p>
</blockquote>

<p>This post assumes, you already know
1.  Content Delivery Network
1.  Service Worker
1.  Basic web terminologies like Cookies, Cache, Requests, etc</p>

<p>Let us see the various scenarios for the traffic and see how to improve in each case.</p>

<ol>
<li>Existing user - logged in</li>
<li>Existing user - not logged in</li>
<li>First time user.</li>
</ol>

<h3 id="existing-user-logged-in-or-not-logged-in">Existing user (logged in or not logged in)</h3>

<p>For existing users, the biggest optimization you could do is to minimize amount of data transferred.</p>

<p>You could do that with Service Worker to intercept the request, and fetch only the dynamic content and render using the prefetched template.</p>

<p>I will explain that technique in detain in a later post.</p>

<h3 id="first-time-user-real-user-or-web-crawler">First time user (Real user or web crawler)</h3>

<p>For the first time user, there is not much optimization you could make. There is no data cached. Also, the request has to go to the server to determine if the user is logged in.
Required to decide whether to serve the static content or the dynamic personalized content.</p>

<p>This trick lies in identifying whether the user is a first time user or existing user. We do it by looking at the cookies.</p>

<p><a href="https://www.codiva.io/">Codiva</a> uses Express with Node. Express sets &lsquo;connect.sid&rsquo; cookie on every response. In Cloudflare Service Worker, we could simply check if this cookie is set. If not, respond with the static home page.</p>

<p>Otherwise, send the request to the server. (Optimizing this case is in later post).</p>

<pre><code>  if (event.request.headers.has('Cookie')
        &amp;&amp; event.request.headers.get('Cookie').indexOf('connect.sid')&gt;=0) {
      // Existing user.  
      event.respondWith(fetch(event.request));
    } else {
      // You may need to set the Page Rule to cache .html files
      var newUrl = new URL('/static/homepage.html', event.request.url);

      event.respondWith(fetch(newUrl.toString())
          .then(function(response){
                // Fix some headers

                var init = {
                    status:     response.status,
                    statusText: response.statusText,
                    headers:    {
                      'Content-Type': 'text/html;charset=UTF-8'

                    }
                };

                for (var pair of response.headers.entries()) {
                  if (pair[0] !== 'expires'
                      &amp;&amp; pair[0] !== 'cache-control') {
                    init.headers[pair[0]] = pair[1];
                  }
                }

                return response.text().then(function(body){
                    return new Response(body, init);
                });
            }

          ));
    }
</code></pre>

<p>If you use other technologies, find the correct cookie. This does not need any change on the downstream server. You could do some sophisticated processing here to identify the right cookie. If you want to modify the server, you could even set a separate cookie when a user logs in. (Remember, the cookie might get invalid. So cookie present just means the user may be logged in. But cookie not present clearly means the user is not logged in.)</p>

<p>The advantage of this solution are.</p>

<ol>
<li>No changes needed on the downstream server.</li>
<li>Very simple to implement and debug</li>
<li>Serves the first time user from the edge. Whether the user comes from search result, search ad, or from direct or other referrals</li>
<li>Search Crawler will see the same content and faster. This is not a blackhat technique.</li>
<li>No redirects for logged in user (Try <a href="https://www.gmail.com">Gmail</a> to see the annoying redirects for logged in user.)</li>
</ol>

    
<ul id="tags" class="tags">
  
  	
	Tags: 
	
  
  
    <li><a href="/blog/tags/cloudflare">Cloudflare</a> </li>
  
    <li><a href="/blog/tags/serviceworker">ServiceWorker</a> </li>
  
</ul>

  </div>

    
  </div>
</body>
</html>
