<!DOCTYPE html>
<html ⚡>
<head>
  <title>Custom Load Balancing With Cloudflare Worker</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

  <link rel="apple-touch-icon" sizes="57x57" href="/img/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/img/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/img/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/img/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/img/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/img/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/img/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/img/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/img/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/img/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="msapplication-TileColor" content="#243342">
  <meta name="msapplication-TileImage" content="/img/ms-icon-144x144.png">
  <meta name="theme-color" content="#243342">

  <link rel="canonical" href="https://www.codiva.io/blog/post/custom-load-balancing-with-cloudflare-worker/">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500">
  <style amp-custom>
     

    * {
      margin: 0;
      padding: 0;
      -moz-box-sizing: border-box;
      -webkit-box-sizing: border-box;
      box-sizing: border-box;
    }
    *, *:before, *:after {
      box-sizing: inherit;
    }
    body {
      font-family: "Roboto", "Helvetica", "Arial", "Verdana", sans-serif;
    }
    blockquote {
        background-color: lightgray;
        padding: 0.25em 0.5em;
        margin: 1em;
        font-size: 1.2em;
    }
    .mainContainer {
      clear: both;
    }
    .mainContainer:after {
      clear: both;
    }
    .mainContainer ol, .mainContainer ul {
      padding: 0 0 0 40px;
    }
    .mainContainer p {
      margin: 1em 0;
    }
    .header a {
      text-decoration: none;
      padding: 1.5em 1em;
    }
    .header a:link, .header a:visited {
      color: white;
      display: inline-block;
    }

    .header {
      padding: 0 10px;
      height: 4em;
      xbackground-color: #06065C;
      background-color: #243342;
      text-color: white;
    }
    .header ul {
      margin: 0px;
      padding: 0px;
    }
    .logo {
      display: inline;
      float: left;
      font-family: "Heiti SC", "Verdana", sans-serif;
    }
    .header .logo a {
      color: #4cae51;
    }
    .top-nav {
      display: inline;
      float: left;
    }
    .top-nav ul {
      list-style: none;
    }
    .top-nav li {
      display: inline;
    }
    .header .login-signup, .header .new-project {
      display: "inline";
      float: right;
    }
    .header .login-signup li,  .header .new-project li, .header .new-project li form {
      display: inline;
    }
    .header .new-project li a, .header .new-project li button {
      margin-top: 0.75em;
    }
    .humanText {
      max-width: 22em;
      margin: auto;
    }
    .header .button {
      padding: 0.75em 1em;
    }
    .bg-orange {
      background-color: #E56723;
      color: white;
    }
    .bg-green {
      background-color: #4CAF50;  

    }
    #logoutForm {
      display: inline
    }
    #logoutLink {
       display: inline;
    }
    .linkButton {
       display: inline;
       background: none;
       border: none;
       cursor: pointer;
       color: white;
    }

    .button {
      border: none;
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 8px;
    }

    .modalDialog {
      z-index: 99999;
      opacity:0;
      -webkit-transition: opacity 400ms ease-in;
      -moz-transition: opacity 400ms ease-in;
      transition: opacity 400ms ease-in;
      pointer-events: none;
    }
     
    .pagination, .tags {
      height: 3em;
    }
    .pagination li, 
    .tags li {
      display: inline;
      min-height: 3em;
    }
    .pagination li a, 
    .tags li a {
      display: inline-block;
      padding: 1em;
    }
    .tags {
      list-style: none;
    }
    .main {
      max-width: 50em;
      margin: 0 auto; 
      line-height: 1.5;
      padding: 1em 1em;
      color: #555;

    }
    .main h2, .main h1 {
      margin-top: 0.5em;
      padding: 0.5em 0;
    }
    .main h1,
    .main h2,
    .main strong {
      color: #333;
    }

    .main pre {
      padding: 1em;
      xbackground: #eee;
    }

    .main a {
      color: #4cae51;
    }

   @media all and (max-width: 650px) {
    .header {
      padding: 0px;
    }
    .top-nav {
      display: none;
    }
    .screenshot, .explain {
        float: none;
        width: 95%;
        height: auto;
        padding-top:1em;
        margin: auto;
    }

    .screenshot img {
      max-width: 100%;
      margin: auto;
      display: block;
    }
   }
   @media all and (max-width: 340px) {
     .logo {
       display: none;
     }
   } 

 
 
  .chroma { color: #f8f8f2; background-color: #272822 }
  .chroma .err { color: #960050; background-color: #1e0010 }
  .chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
  .chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; width: auto; overflow: auto; display: block; }
  .chroma .hl { display: block; width: 100%;background-color: #ffffcc }
  .chroma .lnt { margin-right: 0.4em; padding: 0 0.4em 0 0.4em; }
  .chroma .ln { margin-right: 0.4em; padding: 0 0.4em 0 0.4em; }
  .chroma .k { color: #66d9ef }
  .chroma .kc { color: #66d9ef }
  .chroma .kd { color: #66d9ef }
  .chroma .kn { color: #f92672 }
  .chroma .kp { color: #66d9ef }
  .chroma .kr { color: #66d9ef }
  .chroma .kt { color: #66d9ef }
  .chroma .na { color: #a6e22e }
  .chroma .nc { color: #a6e22e }
  .chroma .no { color: #66d9ef }
  .chroma .nd { color: #a6e22e }
  .chroma .ne { color: #a6e22e }
  .chroma .nf { color: #a6e22e }
  .chroma .nx { color: #a6e22e }
  .chroma .nt { color: #f92672 }
  .chroma .l { color: #ae81ff }
  .chroma .ld { color: #e6db74 }
  .chroma .s { color: #e6db74 }
  .chroma .sa { color: #e6db74 }
  .chroma .sb { color: #e6db74 }
  .chroma .sc { color: #e6db74 }
  .chroma .dl { color: #e6db74 }
  .chroma .sd { color: #e6db74 }
  .chroma .s2 { color: #e6db74 }
  .chroma .se { color: #ae81ff }
  .chroma .sh { color: #e6db74 }
  .chroma .si { color: #e6db74 }
  .chroma .sx { color: #e6db74 }
  .chroma .sr { color: #e6db74 }
  .chroma .s1 { color: #e6db74 }
  .chroma .ss { color: #e6db74 }
  .chroma .m { color: #ae81ff }
  .chroma .mb { color: #ae81ff }
  .chroma .mf { color: #ae81ff }
  .chroma .mh { color: #ae81ff }
  .chroma .mi { color: #ae81ff }
  .chroma .il { color: #ae81ff }
  .chroma .mo { color: #ae81ff }
  .chroma .o { color: #f92672 }
  .chroma .ow { color: #f92672 }
  .chroma .c { color: #75715e }
  .chroma .ch { color: #75715e }
  .chroma .cm { color: #75715e }
  .chroma .c1 { color: #75715e }
  .chroma .cs { color: #75715e }
  .chroma .cp { color: #75715e }
  .chroma .cpf { color: #75715e }
  .chroma .gd { color: #f92672 }
  .chroma .ge { font-style: italic }
  .chroma .gi { color: #a6e22e }
  .chroma .gs { font-weight: bold }
  .chroma .gu { color: #75715e }

 

 



   </style>

  <script async src="https://cdn.ampproject.org/v0.js"></script>
  <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
  <script async custom-element="amp-iframe"
      src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script>
      
<script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>

</head>
<body>

<amp-analytics config="https://www.googletagmanager.com/amp.json?id=GTM-T35PZJ8&gtm.url=SOURCE_URL" data-credentials="include"></amp-analytics>

  <header class="header">
    <span class="logo">
      <a href="/">Codiva.io</a>
    </span>
      
    <nav class="top-nav">
      <ul>
        <li><a href="/blog">Blog</a></li>
        <li><a href="/profile">My Projects</a></li>
        <li><a href="/tutorials">Tutorials</a></li>
      </ul>
    </nav>

  </header>

  <div class="mainContainer">
    
  <div class="main">
    <h2>Custom Load Balancing With Cloudflare Worker</h2>
    <p>Launched your website? Getting lot of traffic? And you are planning to add more servers? You will need load balanacers for scalability and reliability of your website.</p>

<p>In this post, we will learn about load balancers and how to set them up at a low cost with Cloudflare Service Workers.
</p>

<p>This post assumes you know</p>

<ul>
<li>JavaScript</li>
<li>ServiceWorker</li>
<li>Cloudflare Worker</li>
</ul>

<h2 id="the-basic-pattern">The basic pattern</h2>

<p>Intercept a request, and send the request to a different host.</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;fetch&#39;</span><span class="p">,</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

  <span class="c1">// https://example.com/path/ to https://myorigin.example.com/path
</span><span class="c1"></span>  <span class="nx">url</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">=</span> <span class="s1">&#39;myorigin.&#39;</span> <span class="o">+</span> <span class="nx">url</span><span class="p">.</span><span class="nx">hostname</span>
  
  <span class="nx">event</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">));</span>
<span class="p">});</span></code></pre></div>
<p>This doesn&rsquo;t do anything useful yet, but this is the basic pattern that will be used in the rest of the examples.</p>

<h2 id="load-balancer-with-random-routing">Load balancer with random routing</h2>

<p>When you have a list of origin servers, pick a random host to route to.</p>

<p>This is a very basic load balancing technique to evenly distribute the traffic across all origin servers.</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">hostnames</span> <span class="o">=</span> <span class="p">[</span>
  <span class="mf">0.</span><span class="nx">example</span><span class="p">.</span><span class="nx">com</span><span class="p">,</span>
  <span class="mf">1.</span><span class="nx">example</span><span class="p">.</span><span class="nx">com</span><span class="p">,</span>
  <span class="mf">2.</span><span class="nx">example</span><span class="p">.</span><span class="nx">com</span>
<span class="p">];</span>

<span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;fetch&#39;</span><span class="p">,</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

  <span class="c1">// Randomly pick the next host 
</span><span class="c1"></span>  <span class="nx">url</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">=</span> <span class="nx">hostnames</span><span class="p">[</span><span class="nx">getRandomInt</span><span class="p">(</span><span class="nx">hostnames</span><span class="p">.</span><span class="nx">length</span><span class="p">)];</span>
  
  <span class="nx">event</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">));</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">getRandomInt</span><span class="p">(</span><span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">max</span><span class="p">));</span>
<span class="p">}</span></code></pre></div>
<h2 id="load-balancer-with-fallback">Load balancer with fallback</h2>

<p>What to do when the host is down? A simple fallback strategy to route the request to a different host. Use this only if you know the request are idempotent. Mostly GET requests should be okay.</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;fetch&#39;</span><span class="p">,</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

  <span class="c1">// Randomly pick the primary host
</span><span class="c1"></span>  <span class="kd">var</span> <span class="nx">primary</span> <span class="o">=</span> <span class="nx">getRandomInt</span><span class="p">(</span><span class="nx">hostnames</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="nx">url</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">=</span> <span class="nx">hostnames</span><span class="p">[</span><span class="nx">primary</span><span class="p">];</span>

  <span class="kd">var</span> <span class="nx">timeoutId</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">backup</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="c1">// Naive solution to pick a backup host
</span><span class="c1"></span>        <span class="nx">backup</span> <span class="o">=</span> <span class="nx">getRandomInt</span><span class="p">(</span><span class="nx">hostnames</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="nx">backup</span> <span class="o">===</span> <span class="nx">primary</span><span class="p">);</span>

  <span class="p">},</span> <span class="mi">2000</span> <span class="cm">/* 2 seconds */</span><span class="p">);</span>

  <span class="nx">fetch</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timeoutId</span><span class="p">);</span>
        <span class="nx">event</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span></code></pre></div>
<h2 id="sticky-routing">Sticky routing</h2>

<p>You may want to route the subsequent requests from the same user to the same host. This can reduce the latency, if the backend caches the data effectively.</p>

<h2 id="geographic-routing">Geographic routing</h2>

<p>Cloudflare adds <a href="https://support.cloudflare.com/hc/en-us/articles/200168236-What-does-Cloudflare-IP-Geolocation-do-">CF-IPCountry</a> header to all requests once Cloudflare IP Geolocation is enabled.</p>

<p>You can access it using,</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">countryCode</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;CF-IPCountry&#39;</span><span class="p">);</span></code></pre></div>
<p>You may need to provide a mapping of which countries to use which datacenter. If you are starting out, look at the places with most users for your site, and target only those countries.</p>

<p>In my case, India and the US contributes 80% of the traffic. So, for India and its neighbors, use India datacenter. For all others, use the US datacenters.</p>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">const</span> <span class="nx">US_HOST</span> <span class="o">=</span> <span class="s2">&#34;us.example.com&#34;</span>
<span class="k">const</span> <span class="nx">IN_HOST</span> <span class="o">=</span> <span class="s2">&#34;in.example.com&#34;</span>

<span class="kd">var</span> <span class="nx">COUNTRIES_MAP</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">IN</span><span class="o">:</span> <span class="nx">IN_HOST</span><span class="p">,</span>
  <span class="nx">PK</span><span class="o">:</span> <span class="nx">IN_HOST</span><span class="p">,</span>
  <span class="nx">BD</span><span class="o">:</span> <span class="nx">IN_HOST</span><span class="p">,</span>
  <span class="nx">SL</span><span class="o">:</span> <span class="nx">IN_HOST</span><span class="p">,</span>
  <span class="nx">NL</span><span class="o">:</span> <span class="nx">IN_HOST</span>
<span class="p">}</span>
<span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;fetch&#39;</span><span class="p">,</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">countryCode</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;CF-IPCountry&#39;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">COUNTRIES_MAP</span><span class="p">[</span><span class="nx">countryCode</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">url</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">=</span> <span class="nx">COUNTRIES_MAP</span><span class="p">[</span><span class="nx">countryCode</span><span class="p">];</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">url</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">=</span> <span class="nx">US_HOST</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="nx">event</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">));</span>
<span class="p">});</span></code></pre></div>
<h2 id="geographic-routing-with-random-random-loadbalancing-within-datacenter">Geographic routing with random random loadbalancing within datacenter</h2>
<div class="highlight"><pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="k">const</span> <span class="nx">US_HOSTS</span> <span class="o">=</span> <span class="p">[</span>
  <span class="mf">0.</span><span class="nx">us</span><span class="p">.</span><span class="nx">example</span><span class="p">.</span><span class="nx">com</span><span class="p">,</span>
  <span class="mf">1.</span><span class="nx">us</span><span class="p">.</span><span class="nx">example</span><span class="p">.</span><span class="nx">com</span><span class="p">,</span>
  <span class="mf">2.</span><span class="nx">us</span><span class="p">.</span><span class="nx">example</span><span class="p">.</span><span class="nx">com</span>
<span class="p">];</span>

<span class="k">const</span> <span class="nx">IN_HOSTS</span> <span class="o">=</span> <span class="p">[</span>
  <span class="mf">0.</span><span class="k">in</span><span class="p">.</span><span class="nx">example</span><span class="p">.</span><span class="nx">com</span><span class="p">,</span>
  <span class="mf">1.</span><span class="k">in</span><span class="p">.</span><span class="nx">example</span><span class="p">.</span><span class="nx">com</span><span class="p">,</span>
  <span class="mf">2.</span><span class="k">in</span><span class="p">.</span><span class="nx">example</span><span class="p">.</span><span class="nx">com</span>
<span class="p">];</span>

<span class="kd">var</span> <span class="nx">COUNTRIES_MAP</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">IN</span><span class="o">:</span> <span class="nx">IN_HOSTS</span><span class="p">,</span>
  <span class="nx">PK</span><span class="o">:</span> <span class="nx">IN_HOSTS</span><span class="p">,</span>
  <span class="nx">BD</span><span class="o">:</span> <span class="nx">IN_HOSTS</span><span class="p">,</span>
  <span class="nx">SL</span><span class="o">:</span> <span class="nx">IN_HOSTS</span><span class="p">,</span>
  <span class="nx">NL</span><span class="o">:</span> <span class="nx">IN_HOSTS</span>
<span class="p">}</span>
<span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;fetch&#39;</span><span class="p">,</span> <span class="nx">event</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">countryCode</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;CF-IPCountry&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">hostnames</span> <span class="o">=</span> <span class="nx">US_HOSTS</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">COUNTRIES_MAP</span><span class="p">[</span><span class="nx">countryCode</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">hostnames</span> <span class="o">=</span> <span class="nx">COUNTRIES_MAP</span><span class="p">[</span><span class="nx">countryCode</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="c1">// Randomly pick the next host 
</span><span class="c1"></span>  <span class="nx">url</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">=</span> <span class="nx">hostnames</span><span class="p">[</span><span class="nx">getRandomInt</span><span class="p">(</span><span class="nx">hostnames</span><span class="p">.</span><span class="nx">length</span><span class="p">)];</span>
  
  <span class="nx">event</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">));</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">getRandomInt</span><span class="p">(</span><span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">max</span><span class="p">));</span>
<span class="p">}</span></code></pre></div>

    
<ul id="tags" class="tags">
  
  	
	Tags: 
	
  
  
    <li><a href="/blog/tags/cloudflare">Cloudflare</a> </li>
  
    <li><a href="/blog/tags/serviceworker">ServiceWorker</a> </li>
  
    <li><a href="/blog/tags/web">web</a> </li>
  
    <li><a href="/blog/tags/latency">latency</a> </li>
  
    <li><a href="/blog/tags/scaling">scaling</a> </li>
  
</ul>

  </div>

    
  </div>
</body>
</html>
